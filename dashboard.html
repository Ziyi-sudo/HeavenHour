<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘çš„ä¸“æ³¨è®°å½• - HavenHours Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h2>ğŸ“Š æˆ‘çš„ä¸“æ³¨è®°å½•</h2>

    <!-- æ—¥æœŸé€‰æ‹©åŒº + æŒ‰é’® -->
    <div style="margin-bottom: 1em;">
      <label for="dateSelect">é€‰æ‹©æ—¥æœŸï¼š</label>
      <input type="date" id="dateSelect" />
      <button id="updateBtn">æŸ¥çœ‹</button>
    </div>

    <!-- æ˜¾ç¤ºæ±‡æ€»/åˆ—è¡¨/å›¾è¡¨çš„å®¹å™¨ -->
    <div id="summary"></div>
    <div id="recordList"></div>
    <canvas id="taskChart" width="400" height="200"></canvas>
  </div>

  <!-- å…ˆåŠ è½½ Chart.js UMD -->
  <script src="./libs/chart.umd.js"></script>

  <script>
    // 1. è¯»å– LocalStorage é‡Œçš„æ‰€æœ‰æ•°æ®
    const allRecords = JSON.parse(localStorage.getItem("havenRecords")) || [];

    // ç”¨æ¥å­˜å‚¨å›¾è¡¨å®ä¾‹ï¼Œæ–¹ä¾¿æ›´æ–°/é”€æ¯
    let myChart;

    // è·å–é¡µé¢å…ƒç´ 
    const dateInput = document.getElementById("dateSelect");
    const updateBtn = document.getElementById("updateBtn");

    // 2. å®šä¹‰å‡½æ•°ï¼šæ ¹æ®é€‰å®šæ—¥æœŸæ¥æ›´æ–°é¡µé¢å’Œå›¾è¡¨
    function updateChartForDate(selectedDate) {
      // ç­›é€‰å‡ºé€‰å®šæ—¥æœŸçš„è®°å½•
      const records = allRecords.filter(r => r.date === selectedDate);

      // è®¡ç®—æ€»ç§’æ•°ã€ç”Ÿæˆ taskMap
      let totalSeconds = 0;
      let taskMap = {};

      records.forEach(r => {
        const parts = r.duration.split(":");
        const seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        totalSeconds += seconds;
        taskMap[r.taskName] = (taskMap[r.taskName] || 0) + seconds;
      });

      // è½¬æ¢æ€»ç§’æ•° -> å°æ—¶+åˆ†é’Ÿ
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);

      // æ˜¾ç¤ºâ€œç´¯è®¡ä¸“æ³¨â€
      document.getElementById("summary").innerHTML =
        `<p>è¯¥æ—¥æœŸç´¯è®¡ä¸“æ³¨ï¼š<strong>${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ</strong></p>`;

      // åˆ—å‡ºæ‰€æœ‰è®°å½•
      document.getElementById("recordList").innerHTML = records.map(r => `
        <div>ğŸ“ <strong>${r.taskName}</strong>ï¼š${r.startTime} ~ ${r.endTime} (${r.duration})</div>
      `).join("");

      // ç»Ÿè®¡å›¾è¡¨çš„æ•°æ®
      const labels = Object.keys(taskMap);
      const data = Object.values(taskMap).map(s => Math.floor(s / 60));

      // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œå…ˆé”€æ¯å†é‡æ–°åˆ›å»º
      if (myChart) {
        myChart.destroy();
      }

      // 3. åˆ›å»ºæˆ–æ›´æ–° Chart.js å›¾è¡¨
      const ctx = document.getElementById("taskChart").getContext("2d");
      myChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "å„ä»»åŠ¡æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰",
            data,
            backgroundColor: "rgba(75, 192, 192, 0.6)"
          }]
        }
      });
    }

    // 4. é¡µé¢åŠ è½½åï¼Œé»˜è®¤é€‰ä»Šå¤©ï¼Œå¹¶æ¸²æŸ“
    window.addEventListener("DOMContentLoaded", () => {
      // input type="date" è¿”å› YYYY-MM-DD
      const today = new Date().toISOString().slice(0, 10);
      dateInput.value = today;
      updateChartForDate(today);
    });

    // 5. å¦‚æœç”¨æˆ·ç‚¹å‡»â€œæŸ¥çœ‹â€ï¼Œåˆ™æ ¹æ®é€‰ä¸­çš„æ—¥æœŸé‡æ–°æ¸²æŸ“
    updateBtn.addEventListener("click", () => {
      const selectedDate = dateInput.value; // e.g. "2025-03-27"
      if (selectedDate) {
        updateChartForDate(selectedDate);
      }
    });
  </script>
</body>
</html>